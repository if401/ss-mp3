const { Client, GatewayIntentBits, EmbedBuilder } = require('discord.js');
const { joinVoiceChannel, createAudioPlayer, createAudioResource, AudioPlayerStatus, VoiceConnectionStatus, entersState } = require('@discordjs/voice');
const play = require('play-dl');
const { token } = require('./config.json');

play.setToken({
    youtube: {
        cookie: 'YOUR_YOUTUBE_COOKIE' // ì„ íƒì‚¬í•­
    }
});

// í™˜ê²½ ë³€ìˆ˜ ìš°ì„ , ì—†ìœ¼ë©´ ë¡œì»¬ config.json ì‚¬ìš©
const config = {
    token: process.env.TOKEN || process.env.DISCORD_TOKEN,
    clientId: process.env.CLIENT_ID
};

// config.jsonì´ ìˆìœ¼ë©´ ë³‘í•© (ë¡œì»¬ ê°œë°œìš©)
try {
    const localConfig = require('./config.json');
    Object.assign(config, { 
        token: config.token || localConfig.token,
        clientId: config.clientId || localConfig.clientId 
    });
} catch (err) {
    // config.jsonì´ ì—†ì–´ë„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì‘ë™
}

if (!config.token) {
    console.error('í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
    process.exit(1);
}

client.login(config.token);

// í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
const client = new Client({
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildVoiceStates,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.MessageContent
    ]
});

// ì„œë²„ë³„ í ì‹œìŠ¤í…œ (ì—¬ëŸ¬ ì„œë²„ì—ì„œ ë™ì‹œ ì‚¬ìš© ê°€ëŠ¥)
const queues = new Map();

// í êµ¬ì¡°: { connection, player, songs: [], isPlaying, textChannel }
class Queue {
    constructor() {
        this.connection = null;
        this.player = createAudioPlayer();
        this.songs = [];
        this.isPlaying = false;
        this.textChannel = null;
        this.currentSong = null;
    }
}

client.once('ready', () => {
    console.log(`${client.user.tag} ë´‡ì´ ì˜¨ë¼ì¸ì…ë‹ˆë‹¤!`);
});

client.on('messageCreate', async message => {
    if (message.author.bot) return;
    
    const serverQueue = queues.get(message.guild.id);
    
    // /ì¬ìƒ ëª…ë ¹ì–´
    if (message.content.startsWith('/ì¬ìƒ')) {
        await execute(message, serverQueue);
        return;
    }
    
    // /ì¶”ê°€ ëª…ë ¹ì–´
    if (message.content.startsWith('/ì¶”ê°€')) {
        await addToQueue(message, serverQueue);
        return;
    }
    
    // /ìŠ¤í‚µ ëª…ë ¹ì–´
    if (message.content.startsWith('/ìŠ¤í‚µ')) {
        await skip(message, serverQueue);
        return;
    }
    
    // /ëª©ë¡ ëª…ë ¹ì–´
    if (message.content.startsWith('/ëª©ë¡')) {
        await showQueue(message, serverQueue);
        return;
    }
    
    // /í˜„ì¬ ëª…ë ¹ì–´
    if (message.content.startsWith('/í˜„ì¬')) {
        await nowPlaying(message, serverQueue);
        return;
    }
});

// ì¬ìƒ í•¨ìˆ˜
async function execute(message, serverQueue) {
    const args = message.content.split(' ');
    
    // ìŒì„± ì±„ë„ í™•ì¸
    const voiceChannel = message.member.voice.channel;
    if (!voiceChannel) {
        return message.reply('ìŒì„± ì±„ë„ì— ë¨¼ì € ì…ì¥í•´ì£¼ì„¸ìš”!');
    }
    
    // ê²€ìƒ‰ì–´ í™•ì¸
    if (args.length < 2) {
        return message.reply('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”! ì˜ˆ: /ì¬ìƒ ë…¸ë˜ì œëª©');
    }
    
    const searchQuery = args.slice(1).join(' ');
    
    try {
        // play-dlì„ ì‚¬ìš©í•œ ìœ íŠœë¸Œ ê²€ìƒ‰ (ê³ ìŒì§ˆ ìš°ì„ )
        const searchResult = await play.search(searchQuery, { limit: 1, source: { youtube: "video" } });
        
        if (!searchResult || searchResult.length === 0) {
            return message.reply('ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        const video = searchResult[0];
        const song = {
            title: video.title,
            url: video.url,
            duration: video.durationInSec,
            thumbnail: video.thumbnails[0].url,
            requester: message.author.tag
        };
        
        // ì„œë²„ íê°€ ì—†ìœ¼ë©´ ìƒì„±
        if (!serverQueue) {
            const queueConstruct = new Queue();
            queueConstruct.textChannel = message.channel;
            
            queues.set(message.guild.id, queueConstruct);
            queueConstruct.songs.push(song);
            
            try {
                // ìŒì„± ì±„ë„ ì—°ê²°
                const connection = joinVoiceChannel({
                    channelId: voiceChannel.id,
                    guildId: message.guild.id,
                    adapterCreator: message.guild.voiceAdapterCreator,
                });
                
                queueConstruct.connection = connection;
                
                // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
                connection.on(VoiceConnectionStatus.Disconnected, async () => {
                    try {
                        await Promise.race([
                            entersState(connection, VoiceConnectionStatus.Signalling, 5000),
                            entersState(connection, VoiceConnectionStatus.Connecting, 5000),
                        ]);
                    } catch (error) {
                        connection.destroy();
                        queues.delete(message.guild.id);
                    }
                });
                
                // í”Œë ˆì´ì–´ êµ¬ë…
                connection.subscribe(queueConstruct.player);
                
                // ì¬ìƒ ì‹œì‘
                playSong(message.guild, queueConstruct.songs[0]);
                
            } catch (err) {
                console.error(err);
                queues.delete(message.guild.id);
                return message.reply('ìŒì„± ì±„ë„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } else {
            // ê¸°ì¡´ íì— ì¶”ê°€
            serverQueue.songs.push(song);
            
            const embed = new EmbedBuilder()
                .setColor('#0099ff')
                .setTitle('ğŸµ ëŒ€ê¸°ì—´ì— ì¶”ê°€ë¨')
                .setDescription(`[${song.title}](${song.url})`)
                .addFields(
                    { name: 'ê¸¸ì´', value: formatDuration(song.duration), inline: true },
                    { name: 'ìš”ì²­ì', value: song.requester, inline: true },
                    { name: 'ëŒ€ê¸°ì—´ ìœ„ì¹˜', value: `${serverQueue.songs.length}ë²ˆì§¸`, inline: true }
                )
                .setThumbnail(song.thumbnail);
            
            return message.channel.send({ embeds: [embed] });
        }
        
    } catch (error) {
        console.error(error);
        message.reply('ìŒì•…ì„ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// íì— ì¶”ê°€ë§Œ í•˜ëŠ” í•¨ìˆ˜
async function addToQueue(message, serverQueue) {
    const args = message.content.split(' ');
    
    if (!serverQueue) {
        return message.reply('ë¨¼ì € /ì¬ìƒ ëª…ë ¹ì–´ë¡œ ìŒì•…ì„ ì¬ìƒí•´ì£¼ì„¸ìš”!');
    }
    
    if (args.length < 2) {
        return message.reply('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”! ì˜ˆ: /ì¶”ê°€ ë…¸ë˜ì œëª©');
    }
    
    const searchQuery = args.slice(1).join(' ');
    
    try {
        const searchResult = await play.search(searchQuery, { limit: 1, source: { youtube: "video" } });
        
        if (!searchResult || searchResult.length === 0) {
            return message.reply('ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        const video = searchResult[0];
        const song = {
            title: video.title,
            url: video.url,
            duration: video.durationInSec,
            thumbnail: video.thumbnails[0].url,
            requester: message.author.tag
        };
        
        serverQueue.songs.push(song);
        
        const embed = new EmbedBuilder()
            .setColor('#0099ff')
            .setTitle('âœ… ëŒ€ê¸°ì—´ì— ì¶”ê°€ë¨')
            .setDescription(`[${song.title}](${song.url})`)
            .addFields(
                { name: 'ê¸¸ì´', value: formatDuration(song.duration), inline: true },
                { name: 'ìš”ì²­ì', value: song.requester, inline: true },
                { name: 'ëŒ€ê¸°ì—´ ìœ„ì¹˜', value: `${serverQueue.songs.length}ë²ˆì§¸`, inline: true }
            )
            .setThumbnail(song.thumbnail);
        
        message.channel.send({ embeds: [embed] });
        
    } catch (error) {
        console.error(error);
        message.reply('ìŒì•…ì„ ì¶”ê°€í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ì‹¤ì œ ì¬ìƒ í•¨ìˆ˜
async function playSong(guild, song) {
    const serverQueue = queues.get(guild.id);
    
    if (!song) {
        // íê°€ ë¹„ì—ˆìœ¼ë©´ ì—°ê²° ì¢…ë£Œ
        serverQueue.connection.destroy();
        queues.delete(guild.id);
        return;
    }
    
    try {
        // play-dlë¡œ ìŠ¤íŠ¸ë¦¼ ìƒì„± (ê³ ìŒì§ˆ ì„¤ì •)
        const stream = await play.stream(song.url, {
            quality: 3, // 0: ìµœì €, 1: ì €, 2: ê³ , 3: ìµœê³ 
        });
        
        const resource = createAudioResource(stream.stream, {
            inputType: stream.type,
        });
        
        serverQueue.currentSong = song;
        serverQueue.isPlaying = true;
        
        serverQueue.player.play(resource);
        
        // ì¬ìƒ ì™„ë£Œ ì‹œ ë‹¤ìŒ ê³¡ìœ¼ë¡œ
        serverQueue.player.once(AudioPlayerStatus.Idle, () => {
            serverQueue.songs.shift();
            playSong(guild, serverQueue.songs[0]);
        });
        
        // ì¬ìƒ ì‹œì‘ ì•Œë¦¼
        const embed = new EmbedBuilder()
            .setColor('#00ff00')
            .setTitle('ğŸ¶ ì¬ìƒ ì¤‘')
            .setDescription(`[${song.title}](${song.url})`)
            .addFields(
                { name: 'ê¸¸ì´', value: formatDuration(song.duration), inline: true },
                { name: 'ìš”ì²­ì', value: song.requester, inline: true }
            )
            .setThumbnail(song.thumbnail);
        
        serverQueue.textChannel.send({ embeds: [embed] });
        
    } catch (error) {
        console.error(error);
        serverQueue.textChannel.send('ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ê³¡ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.');
        serverQueue.songs.shift();
        playSong(guild, serverQueue.songs[0]);
    }
}

// ìŠ¤í‚µ í•¨ìˆ˜
async function skip(message, serverQueue) {
    if (!message.member.voice.channel) {
        return message.reply('ìŒì„± ì±„ë„ì— ì…ì¥í•´ì£¼ì„¸ìš”!');
    }
    
    if (!serverQueue || !serverQueue.isPlaying) {
        return message.reply('ì¬ìƒ ì¤‘ì¸ ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤!');
    }
    
    serverQueue.player.stop();
    message.reply('â­ï¸ ë‹¤ìŒ ê³¡ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.');
}

if (message.content === '/ì¼ì‹œì •ì§€') {
    serverQueue.player.pause();
    message.reply('â¸ï¸ ì¼ì‹œì •ì§€ë¨');
}

if (message.content === '/ì¬ê°œ') {
    serverQueue.player.unpause();
    message.reply('â–¶ï¸ ì¬ìƒ ì¬ê°œ');
}

// ëŒ€ê¸°ì—´ ëª©ë¡ í‘œì‹œ
async function showQueue(message, serverQueue) {
    if (!serverQueue || serverQueue.songs.length === 0) {
        return message.reply('ëŒ€ê¸°ì—´ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');
    }
    
    const current = serverQueue.currentSong;
    const upcoming = serverQueue.songs.slice(1, 11); // ìµœëŒ€ 10ê³¡ê¹Œì§€ í‘œì‹œ
    
    let queueList = `**í˜„ì¬ ì¬ìƒ ì¤‘:**\nğŸµ [${current.title}](${current.url}) - ${formatDuration(current.duration)}\nìš”ì²­: ${current.requester}\n\n`;
    
    if (upcoming.length > 0) {
        queueList += `**ë‹¤ìŒ ê³¡:**\n`;
        upcoming.forEach((song, index) => {
            queueList += `${index + 1}. [${song.title}](${song.url}) - ${formatDuration(song.duration)}\n`;
        });
    }
    
    if (serverQueue.songs.length > 11) {
        queueList += `\n...ê·¸ ì™¸ ${serverQueue.songs.length - 11}ê³¡`;
    }
    
    const embed = new EmbedBuilder()
        .setColor('#ff9900')
        .setTitle('ğŸ“‹ í˜„ì¬ ëŒ€ê¸°ì—´')
        .setDescription(queueList)
        .setFooter({ text: `ì´ ${serverQueue.songs.length}ê³¡` });
    
    message.channel.send({ embeds: [embed] });
}

// í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ê³¡ ì •ë³´
async function nowPlaying(message, serverQueue) {
    if (!serverQueue || !serverQueue.currentSong) {
        return message.reply('ì¬ìƒ ì¤‘ì¸ ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤!');
    }
    
    const song = serverQueue.currentSong;
    
    const embed = new EmbedBuilder()
        .setColor('#ff0099')
        .setTitle('ğŸµ í˜„ì¬ ì¬ìƒ ì¤‘')
        .setDescription(`[${song.title}](${song.url})`)
        .addFields(
            { name: 'ê¸¸ì´', value: formatDuration(song.duration), inline: true },
            { name: 'ìš”ì²­ì', value: song.requester, inline: true },
            { name: 'ëŒ€ê¸°ì—´', value: `${serverQueue.songs.length}ê³¡`, inline: true }
        )
        .setThumbnail(song.thumbnail)
        .setTimestamp();
    
    message.channel.send({ embeds: [embed] });
}

// ì‹œê°„ í¬ë§· ë³€í™˜ (ì´ˆ -> ë¶„:ì´ˆ)
function formatDuration(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
}

// ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê°ì†Œë¥¼ ìœ„í•œ í í¬ê¸° ì œí•œ
class Queue {
    constructor() {
        this.connection = null;
        this.player = createAudioPlayer();
        this.songs = [];
        this.maxQueueSize = 50; // ìµœëŒ€ 50ê³¡ìœ¼ë¡œ ì œí•œ
        this.isPlaying = false;
        this.textChannel = null;
        this.currentSong = null;
    }
    
    addSong(song) {
        if (this.songs.length >= this.maxQueueSize) {
            return false;
        }
        this.songs.push(song);
        return true;
    }
}

// ë¹„í™œì„± ìƒíƒœì—ì„œ ìë™ ì—°ê²° í•´ì œ (ë¦¬ì†ŒìŠ¤ ì ˆì•½)
let inactivityTimer;

function resetInactivityTimer(guild) {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        const serverQueue = queues.get(guild.id);
        if (serverQueue && serverQueue.songs.length === 0) {
            serverQueue.connection.destroy();
            queues.delete(guild.id);
            serverQueue.textChannel.send('ë¹„í™œì„± ìƒíƒœë¡œ ìŒì„± ì±„ë„ì—ì„œ ë‚˜ê°‘ë‹ˆë‹¤.');
        }
    }, 300000); // 5ë¶„
}

client.login(token);